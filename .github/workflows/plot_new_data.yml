name: Process Data and Deploy to Pages

on:
  push:
    branches: [main]
    paths:
      - "data/*.csv"
      - "data/*.parquet"

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: List output folder
        run: |
          echo "Listing output directory:"
          ls -R output || echo "output directory missing"
      
      - name: Debug workspace
        run: |
          echo "PWD:"
          pwd
          echo "Repo contents:"
          ls -R .

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt || pip install pandas numpy plotly pyarrow

      # -------------------------------------------------------
      # Detect new data file
      # -------------------------------------------------------
      - name: Get changed files
        id: changes
        run: |
          echo "CHANGES=$(git diff --name-only HEAD~1 HEAD | tr '\n' ' ')" >> $GITHUB_ENV

      - name: Determine new data files
        id: filter
        run: |
          files=$(echo "$CHANGES" | tr ' ' '\n' | grep -E '^data/.*\.(csv|parquet)$' || true)
          echo "FOUND=$files" >> $GITHUB_ENV

      - name: Show found data files
        run: |
          echo "Found data files: $FOUND"

      - name: Exit if nothing new
        if: env.FOUND == ''
        run: |
          echo "No new data files â€” stopping."
          exit 0

      # -------------------------------------------------------
      # Run main.py for each new file
      # -------------------------------------------------------
      - name: Run main.py for each new data file
        run: |
          for f in $FOUND; do
            echo "Running main.py on $f..."
            python main.py "$f"
          done

      # -------------------------------------------------------
      # Compress HTML output to allow Pages upload
      # -------------------------------------------------------
      - name: Compress HTML files
        run: |
          mkdir -p output
          for f in output/*.html; do
            echo "Compressing $f..."
            gzip -9 "$f"
            mv "$f.gz" "$f"      # keeps .html extension (browsers auto-decompress)
          done

      # -------------------------------------------------------
      # Upload to Pages artifact
      # -------------------------------------------------------
      - name: Upload site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: output

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
