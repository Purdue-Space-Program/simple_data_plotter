name: Check for New Data Files

on:
  push:
    branches:
      - "**"

jobs:
  detect-new-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo with history
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get list of changed files
        id: changes
        shell: bash
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD)
          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          echo "$CHANGED" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "Changed files:"
          echo "$CHANGED"

      - name: Detect .csv or .parquet
        id: detect
        shell: bash
        run: |
          echo "Checking CHANGED_FILES:"
          echo "$CHANGED_FILES"

          NEW_DATA_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(csv|parquet)$' || true)

          echo "NEW_DATA_FILES<<EOF" >> $GITHUB_ENV
          echo "$NEW_DATA_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          if [ -n "$NEW_DATA_FILES" ]; then
            echo "found=true" >> $GITHUB_ENV
            echo "New data files detected:"
            echo "$NEW_DATA_FILES"
          else
            echo "found=false" >> $GITHUB_ENV
            echo "No new data files detected."
          fi

      - name: Set up Python
        if: env.found == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: env.found == 'true'
        run: |
          pip install --upgrade pip
          pip install numpy pandas plotly pyarrow

      - name: Run main.py for each new file
        if: env.found == 'true'
        shell: bash
        run: |
          echo "Running main.py for detected files..."
          echo "$NEW_DATA_FILES" | while read file; do
            if [ -n "$file" ]; then
              echo "Processing: $file"
              python main.py "$file"
            fi
          done
